<!DOCTYPE html>

<html lang="en">
<head>
	<meta charset="utf-8">
	<title>BeFF Source: Component/Form.js</title>

	<!--[if lt IE 9]>
	<script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
	<![endif]-->
	<link type="text/css" rel="stylesheet" href="styles/sunlight.default.css">

	
	<link type="text/css" rel="stylesheet" href="styles/site.spacelab.css">
	
</head>

<body>
<div class="container-fluid">
	<div class="navbar navbar-fixed-top navbar-inverse">
		<div class="navbar-inner">
			<a class="brand" href="index.html">BeFF</a>
			<ul class="nav">
				
				<li class="dropdown">
					<a href="modules.list.html" class="dropdown-toggle" data-toggle="dropdown">Modules<b
						class="caret"></b></a>

					<ul class="dropdown-menu ">
						
						<li>
							<a href="module-Container.html">Container</a>
						</li>
						

					</ul>
				</li>
				
				<li class="dropdown">
					<a href="global.html" class="dropdown-toggle" data-toggle="dropdown">Global<b
						class="caret"></b></a>

					<ul class="dropdown-menu ">
						
						<li>
							<a href="global.html#_catch">_catch</a>
						</li>
						
						<li>
							<a href="global.html#commit">commit</a>
						</li>
						
						<li>
							<a href="global.html#toggleElement">toggleElement</a>
						</li>
						
						<li>
							<a href="global.html#validator">validator</a>
						</li>
						

					</ul>
				</li>
				
			</ul>
		</div>
	</div>

	<div class="row-fluid">

		
			<div class="span12">
				
				<div id="main">
					


		<h1 class="page-title">Source: Component/Form.js</h1>
    
    <section>
        <article>
            <pre class="sunlight-highlight-javascript linenums">define([
  'nbd/Promise',
  'nbd/util/extend',
  'nbd/util/pipe',
  '../Component',
  '../util/xhr',
  '../util/error'
], function(Promise, extend, pipe, Component, xhr, error) {
  'use strict';

  /**
   * Takes a serialized Array (such as from $.serializeArray) and
   * transforms it into a JSON structure apporpriate for sending
   * as data over and ajax request.
   *
   * @param {Array} inputs - List objects with the form { name: 'foo', value: 'bar' }
   *
   * @return {Object} obj - Map of input names to input values
   */
  function decompose(inputs) {
    return inputs.reduce(function(obj, entry) {
      var val = obj[entry.name];

      obj[entry.name] = val ?
        // Format selects into { name: [value1, value2,...] }
        [].concat(val, entry.value) :
        entry.value;

      return obj;
    }, {});
  }

  var normalizeSubmitter = function(e) {
    switch (e.which) {
      // Left mouse
      case 1:
      // Enter
      case 13:
      // Spacebar
      case 32:
        this.$form.submit();
        break;
      default:
        break;
    }
  },

  innerChain = function(metadata) {
    var chain = new Promise(),
    then = chain.thenable(),
    retval = typeof this.commit === 'function' ?
      this.commit.call(then, metadata) :
      this.commmit;

    chain.resolve(retval === then ? xhr(metadata) : retval);

    return chain;
  },

  findFields = function(err) {
    if (!(err instanceof Object)) { throw err; }
    var meta = this._cacheMeta || this.toJSON(),

    matches = Object.keys(meta.data)
    .filter(err.hasOwnProperty.bind(err)),

    results = matches
    .reduce(function(o, key) {
      o[key] = err[key];
      return o;
    }, {});

    if (matches.length) {
      throw new this.constructor.Error(results);
    }
    throw err;
  },

  Form = Component.extend({
    init: function($context) {
      this.$form = $context.is('form') ? $context : $context.find('form');

      // Internal bindings so that we can unbind later
      this._normalizeSubmitter = normalizeSubmitter.bind(this);
      this.submit = this.submit.bind(this);

      // Error handling chain
      this.on('error', function(e) {
        error.call([this._catch.bind(this)], e)
        .catch(error)
        .finally(function() {
          delete this._cacheMeta;
        }.bind(this));
      });
    },

    destroy: function() {
      this._super();
      this.$form = null;
    },

    /**
     * Default validator does nothing
     */
    validator: function(data) { return true; },

    /**
     * Inner Submission process. Should be limited to the forms specific behaviors that are
     * dependent on pre- and post- submission of the form. For the majority of simple forms,
     * this should be all that needs to be overridden.
     *
     * Default implementation simply submits the form data to the form's defined endpoint.
     */
    commit: function(metadata) {
      return this;
    },

    /**
     * Default error catch
     */
    _catch: function(err) {
      if (!(err instanceof Form.Error)) {
        throw err;
      }

      Object.keys(err).forEach(function(name) {
        var $element = this.$form.find('[name=' + name + '], #' + name).first();
        if ($element.length) {
          this.trigger('error:show', $element, err[name]);
          $element.one('input', this.trigger.bind(this, 'error:hide', $element));
        }
      }, this);
    },

    submit: function(e) {
      this.trigger('before', e);
      var chain = this._submit(e);
      chain
      .catch(findFields.bind(this))
      .then(this.trigger.bind(this, 'success'), this.trigger.bind(this, 'error'));

      return chain;
    },

    _submit: function(e) {
      var validator = Array.isArray(this.validator) ?
            pipe.apply(null, this.validator.map(function(validator) {
              return validator.bind(this);
            }, this)) :
            this.validator.bind(this),
          resolver = new Promise(),
          meta, valid, error;

      this._cacheMeta = meta = this.toJSON();
      try {
        valid = validator(meta.data);
      }
      catch (validationError) {
        valid = false;
        error = validationError;
      }
      valid = valid !== false;

      if (e && (!valid || typeof this.commit === 'function')) {
        e.preventDefault();
      }

      if (!valid) {
        resolver.reject(error);
      }
      else {
        resolver.resolve(meta);
      }
      return resolver.then(innerChain.bind(this));
    },

    toJSON: function() {
      return {
        url: this.$form.attr('action'),
        type: this.$form.attr('method') || 'POST',
        data: this.constructor.decompose(this.$form.serializeArray())
      };
    },

    _submitSelector: '.js-submit:not([type=submit])',

    bind: function() {
      this.$form
      .on('click keydown', this._submitSelector, this._normalizeSubmitter)
      .on('submit', this.submit);
      return this;
    },

    unbind: function() {
      this.$form
      .off('click keydown', this._submitSelector, this._normalizeSubmitter)
      .off('submit', this.submit);
      return this;
    }
  }, {
    decompose: decompose,

    Error: function FormError(messages) {
      extend(this, messages);
    }
  });

  return Form;
});
</pre>
        </article>
    </section>





				</div>

				<div class="clearfix"></div>
				<footer>
					
					
		<span class="copyright">
		Behance
		</span>
					<br />
					
		<span class="jsdoc-message">
		Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.2.2</a>
		on Wed Jun 18 2014 17:09:01 GMT-0400 (EDT) using the <a href="https://github.com/terryweiss/docstrap">DocStrap template</a>.
		</span>
				</footer>
			</div>

			
			<br clear="both">
		</div>

	</div>
	<script src="scripts/sunlight.js"></script>
	<script src="scripts/sunlight.javascript.js"></script>
	<script src="scripts/sunlight-plugin.doclinks.js"></script>
	<script src="scripts/sunlight-plugin.linenumbers.js"></script>
	<script src="scripts/sunlight-plugin.menu.js"></script>
	<script src="scripts/jquery.min.js"></script>
	<script src="scripts/jquery.scrollTo.js"></script>
	<script src="scripts/jquery.localScroll.js"></script>
	<script src="scripts/bootstrap-dropdown.js"></script>
	<script src="scripts/toc.js"></script>


	<script>  Sunlight.highlightAll({lineNumbers:true,  showMenu: true, enableDoclinks :true}); </script>

	<script>
		$( function () {
			$( "#toc" ).toc( {
				selectors   : "h1,h2,h3,h4",
				showAndHide : false,
				scrollTo    : 60
			} );
			$( "#toc>ul" ).addClass( "nav nav-pills nav-stacked" );
			$( "#main span[id^='toc']" ).addClass( "toc-shim" );

		} );
	</script>

	

</body>
</html>
